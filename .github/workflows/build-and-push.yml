# ============================================================
# üöÄ Build & Push PETBIO11 to GHCR
# ------------------------------------------------------------
# Este workflow compila y sube las im√°genes Docker del proyecto
# PETBIO11 (NGINX y Plataforma principal) al GitHub Container
# Registry (GHCR).
#
# üß† Beneficios:
#   - Automatiza los despliegues cuando haces push a main.
#   - Versiona las im√°genes por commit SHA y etiqueta "latest".
#   - Garantiza consistencia entre Render y GitHub Actions.
# ============================================================

name: üöÄ Build & Push PETBIO11 to GHCR

on:
  # üîÅ Ejecutar autom√°ticamente cuando haya cambios en la rama main
  push:
    branches: [ "main" ]

  # üîç Permitir ejecuci√≥n manual desde PRs (opcional)
  pull_request:
    branches: [ "main" ]

# ============================================================
# üß© JOB PRINCIPAL
# ============================================================
jobs:
  build:
    # üíª GitHub usa un runner Linux para compilar Docker
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------
      # 1Ô∏è‚É£ Clonar el repositorio
      # --------------------------------------------------------
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # 2Ô∏è‚É£ Autenticarse en GitHub Container Registry (GHCR)
      # --------------------------------------------------------
      # üí° GHCR_PAT es un token personal con permisos de:
      #     - write:packages
      #     - read:packages
      #     - delete:packages (opcional)
      #     - repo
      #
      # üìç Se configura desde GitHub ‚Üí Settings ‚Üí Secrets ‚Üí Actions
      #     Nombre: GHCR_PAT
      # --------------------------------------------------------
      - name: üîê Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_PAT }}

      # --------------------------------------------------------
      # 3Ô∏è‚É£ Construir la imagen NGINX
      # --------------------------------------------------------
      #   - Usa el Dockerfile del directorio NGINX_WEB_PETBIO11
      #   - Etiqueta doble:
      #       latest ‚Üí para Render (√∫ltima estable)
      #       sha ‚Üí versi√≥n exacta del commit
      # --------------------------------------------------------
      - name: üß± Build NGINX image
        run: |
          docker build ./NGINX_WEB_PETBIO11 \
            -f ./NGINX_WEB_PETBIO11/Dockerfile \
            -t ghcr.io/${{ github.repository_owner }}/nginx_petbio11:latest \
            -t ghcr.io/${{ github.repository_owner }}/nginx_petbio11:${{ github.sha }}

      # --------------------------------------------------------
      # 4Ô∏è‚É£ Construir la imagen de la plataforma principal (PHP-FPM)
      # --------------------------------------------------------
      #   - Similar al anterior, pero para el backend principal
      # --------------------------------------------------------
      - name: üß™ Build Platform image
        run: |
          docker build ./petbio11-platform \
            -f ./petbio11-platform/Dockerfile \
            -t ghcr.io/${{ github.repository_owner }}/petbio_platform:latest \
            -t ghcr.io/${{ github.repository_owner }}/petbio_platform:${{ github.sha }}

      # --------------------------------------------------------
      # 5Ô∏è‚É£ Subir las im√°genes a GHCR
      # --------------------------------------------------------
      #   - Sube las dos versiones por cada imagen:
      #       latest ‚Üí Render siempre usar√° esta
      #       sha ‚Üí sirve como hist√≥rico / rollback
      # --------------------------------------------------------
      - name: üöÄ Push images to GHCR
        run: |
          docker push ghcr.io/${{ github.repository_owner }}/nginx_petbio11:latest
          docker push ghcr.io/${{ github.repository_owner }}/nginx_petbio11:${{ github.sha }}
          docker push ghcr.io/${{ github.repository_owner }}/petbio_platform:latest
          docker push ghcr.io/${{ github.repository_owner }}/petbio_platform:${{ github.sha }}

# ============================================================
# ‚úÖ NOTAS FINALES
# ------------------------------------------------------------
# - Este workflow solo se ejecuta si hay cambios en main.
# - Render puede consumir las im√°genes desde:
#     ghcr.io/rnbm2025-petbioweb/nginx_petbio11:latest
#     ghcr.io/rnbm2025-petbioweb/petbio_platform:latest
# - Aseg√∫rate de haber configurado GHCR_PAT en GitHub Secrets.
# ============================================================
