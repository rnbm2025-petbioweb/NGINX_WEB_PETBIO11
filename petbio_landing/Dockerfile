# =========================================================
# 🐳 PETBIO11 - Landing + Formularios
# PHP 8.2 + Nginx + Supervisor + Seguridad
# =========================================================
FROM php:8.2-fpm

RUN apt-get update && \
    apt-get install -y nginx supervisor nano bash curl unzip && \
    docker-php-ext-install mysqli pdo pdo_mysql && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Copiar configuración Nginx
COPY petbio_landing/nginx.conf /etc/nginx/nginx.conf
COPY conf.d/ /etc/nginx/conf.d/
COPY security-headers.conf /etc/nginx/security-headers.conf

# Copiar app PHP
COPY ./petbio_landing /var/www/html/

# Supervisor config
COPY deploy/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Permisos y configuración PHP
RUN chown -R www-data:www-data /var/www/html && \
    chmod -R 755 /var/www/html

RUN { \
    echo "cgi.fix_pathinfo=0"; \
    echo "upload_max_filesize=250M"; \
    echo "post_max_size=250M"; \
    echo "max_execution_time=300"; \
} > /usr/local/etc/php/conf.d/uploads.ini

RUN mkdir -p /var/log/nginx && chmod -R 755 /var/log/nginx

EXPOSE 80

# Iniciar Supervisor (levanta PHP-FPM y Nginx)
CMD ["/usr/bin/supervisord", "-n", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
