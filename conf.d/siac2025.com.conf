# ======================================
# Redirección HTTP → HTTPS
# ======================================
server {
    listen 80;
    server_name siac2025.com www.siac2025.com;
    return 301 https://$host$request_uri;
}

# ======================================
# Servidor principal HTTPS siac2025.com
# ======================================
server {
    listen 443 ssl;
    http2 on;  # ✅ nueva forma recomendada
    server_name siac2025.com www.siac2025.com;

    root /var/www/siac2025.com;
    index index.php index.html;

    # ======================================
    # Certificados SSL Let's Encrypt
    # ======================================
    ssl_certificate     /etc/letsencrypt/live/siac2025.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/siac2025.com/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # ======================================
    # Cloudflare: IPs reales
    # ======================================
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;
    real_ip_header CF-Connecting-IP;

    # ======================================
    # Seguridad
    # ======================================
    include /etc/nginx/security-headers.conf;

    add_header Content-Security-Policy "
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://*.googlesyndication.com https://www.googletagmanager.com https://www.google-analytics.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.tailwindcss.com;
        img-src 'self' data: https://*.googlesyndication.com https://*.google-analytics.com https://*.doubleclick.net;
        font-src 'self' https://fonts.gstatic.com;
        connect-src 'self' https://www.google-analytics.com https://*.doubleclick.net;
        frame-src https://*.googlesyndication.com https://*.doubleclick.net;
        object-src 'none';
        base-uri 'self';
        form-action 'self';
        frame-ancestors 'self';
    " always;

    # ======================================
    # Contenido principal
    # ======================================
    location / {
        try_files $uri $uri/ =404;
    }

    # ======================================
    # Protección de archivos sensibles
    # ======================================
    location ~* \.(?:conf|php|sh|sql|bak|env|yml|ini|log)$ {
        deny all;
        return 403;
    }

    # ======================================
    # Archivo ads.txt (Google Ads)
    # ======================================
    location = /ads.txt {
        default_type text/plain;
        root /var/www/siac2025.com;
    }

    # ======================================
    # Archivos estáticos (cache optimizado)
    # ======================================
    location ~* \.(?:jpg|jpeg|png|gif|ico|webp|svg|css|js|woff2?|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        access_log off;
    }

    # ======================================
    # Logs
    # ======================================
    access_log /var/log/nginx/siac2025-access.log;
    error_log /var/log/nginx/siac2025-error.log;
}
